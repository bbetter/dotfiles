#!/bin/bash

DOTFILES_DIR="$HOME/.dotfiles"

echo "üì¶ Updating package lists..."

cd "$DOTFILES_DIR" || exit 1

# Backup —Å—Ç–∞—Ä–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
cp packages.txt packages.txt.old 2>/dev/null || true
cp aur-packages.txt aur-packages.txt.old 2>/dev/null || true

# –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–∫–∏
pacman -Qqe | grep -v "$(pacman -Qqm)" > packages.txt
pacman -Qqm > aur-packages.txt

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –∑–º—ñ–Ω–∏
if ! diff -q packages.txt packages.txt.old &>/dev/null || \
   ! diff -q aur-packages.txt aur-packages.txt.old &>/dev/null; then
    
    echo ""
    echo "‚úÖ Package lists updated!"
    echo ""
    echo "üìù Changes:"
    
    # –ü–æ–∫–∞–∑–∞—Ç–∏ —â–æ –¥–æ–¥–∞–ª–æ—Å—å/–≤–∏–¥–∞–ª–∏–ª–æ—Å—å
    if [ -f packages.txt.old ]; then
        echo ""
        echo "Official packages:"
        diff -u packages.txt.old packages.txt | grep "^[+-]" | grep -v "^[+-][+-]" || echo "  No changes"
    fi
    
    if [ -f aur-packages.txt.old ]; then
        echo ""
        echo "AUR packages:"
        diff -u aur-packages.txt.old aur-packages.txt | grep "^[+-]" | grep -v "^[+-][+-]" || echo "  No changes"
    fi
    
    # –í–∏–¥–∞–ª–∏—Ç–∏ backup
    rm -f packages.txt.old aur-packages.txt.old
    
    echo ""
    read -p "Commit changes? (y/N) " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git add packages.txt aur-packages.txt
        git commit -m "Update package lists: $(date +'%Y-%m-%d')"
        echo "‚úÖ Committed!"
        
        read -p "Push to GitHub? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git push
            echo "üì§ Pushed!"
        fi
    fi
else
    echo "‚ÑπÔ∏è  No changes in package lists"
    rm -f packages.txt.old aur-packages.txt.old
fi
